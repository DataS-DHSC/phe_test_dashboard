---
title: "Covid-19 Positive Tests by Local Authority"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    runtime: shiny
---

<style>                     
.navbar {
  background-color:#00ad93;
  border-color:black;
}
</style> 

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(tidyquant)
library(ggthemes)
library(ggdark)
library(DT)
library(plotly)
library(ggrepel)
library(shiny)
library(httr)

today_date <- Sys.Date()

tmp <- tempfile()
GET("https://coronavirus.data.gov.uk/downloads/csv/coronavirus-cases_latest.csv", write_disk(tmp))
readLines(tmp)
df <- read.csv(tmp)

df <- df %>%
  mutate_at('Specimen.date', ~ as.Date(.)) %>%
  filter(Area.type == "Upper tier local authority") %>%
  select(Area.name, Area.code, Specimen.date, Daily.lab.confirmed.cases,
    Cumulative.lab.confirmed.cases, Cumulative.lab.confirmed.cases.rate) %>% 
  rename(
    area = 'Area.name',
    code = 'Area.code',
    date = 'Specimen.date', 
    daily_cases = 'Daily.lab.confirmed.cases', 
    cumulative_cases = 'Cumulative.lab.confirmed.cases', 
    cases_rate = 'Cumulative.lab.confirmed.cases.rate'
  ) %>%
  group_by(area) %>%
  tq_mutate(
    # tq_mutate args
    select = cumulative_cases,
    mutate_fun = rollapply, 
    # rollapply args
    width = 7,
    align = "right",
    FUN = mean,
    # mean args
    na.rm = TRUE,
    # tq_mutate args
    col_rename = "rolling_mean_7_days_per_la"
  ) %>%
  ungroup

# I need this so that filtering doesn't return zero-row data frames
# Ideally, data will be automaticall y download, so this piece of code is temp only
if (today_date > max(df$date)) {
  today_date <- max(df$date)
}

recent_week_all_df <- df %>% 
  filter(date <= today_date - 9) %>%
  group_by(area) %>% 
  summarise(cases = sum(daily_cases))

previous_week_all_df <- df %>% 
  filter(date <= today_date - 16) %>%
  group_by(area) %>% 
  summarise(cases = sum(daily_cases))

names(previous_week_all_df) <- c("area", "previous_week_cases")


df_joined <- left_join(recent_week_all_df, previous_week_all_df) %>%
  mutate(change = cases - previous_week_cases)

make_hist <- function(df) {
  df %>%
    ggplot(
      aes(
        date, 
        daily_cases, 
        text = 
          paste(
            paste0('Local Authority: ', area),
            '\n',
            paste0('Day: ', date),
            '\n',
            paste0('Number of cases on that day: ', daily_cases)
          ),
        alpha = 0.5
      )
    ) +
    geom_bar(stat = "identity", position = "identity", fill = "#00ad93") +
    theme_bw() +
    theme(
      legend.position = 'none',
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank()
    ) + 
    xlab('') + 
    ylab('Daily cases')
}

make_bar <- function(df, key_var, chart_title, top_how_many = 20) {
  df %>%
    select(area, all_of(key_var)) %>%
    group_by(area) %>%
    summarize_all(max) %>%
    ungroup %>%
    rename(key_var = all_of(key_var)) %>%
    arrange(key_var) %>%
    mutate(area = factor(area, levels = area)) %>%
    arrange(desc(all_of(key_var))) %>%
    slice(1:top_how_many) %>%
    ggplot(
      aes(
        area, 
        key_var, 
        text = 
          paste(
            paste0('Local Authority: ', area),
            '\n',
            paste0('Number of cases: ', key_var)
          ),
        alpha = 0.5
      )
    ) +
    geom_bar(stat = "identity", width = 0.8, fill = '#00ad93') +
    coord_flip() +
    labs(x = "", y = "", title = chart_title) +
    theme_bw() +
    theme(
      legend.position = 'none',
      axis.title = element_text(size = 14, colour = "black"),
      axis.text.y = element_text(size = 11, face = "bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank()
    )
}
  
bar1 <- make_bar(
  df, 
  "cumulative_cases", 
  "Number of cases across the pandemic", 
  top_how_many = 20
)

recent_week_df <- df %>% 
  filter(date >= today_date - 9 & date <= today_date - 3) %>%
  group_by(area) %>% 
  summarise(cases = sum(daily_cases)) %>% 
  arrange(desc(cases))

chart_max <- round(max(recent_week_df$cases), -2)

bar2 <- recent_week_df %>%
  make_bar(
    "cases",
    paste(
      "Cases between", 
      format(today_date - 9,"%a %b %d"),
      "and",
      format(today_date - 3,"%a %b %d")
    )
  )

scatter <- df_joined %>%
  ggplot(
    aes(
      x = cases, 
      y = change,
      text = 
        paste(
          paste0('Local Authority: ', area),
          '\n',
<<<<<<< HEAD
         paste0('Number of new cases within time period: ', change)
=======
         paste0('Number of cases: ', change)
>>>>>>> cb48fc55c892fe353ae77e714f9a707e9c63bd47
        )
    )
  ) +
  geom_point(colour = "#00ad93", fill = "#00ad93", size = df_joined$change / 50) +
  labs(
    title = 
    paste(
      "Cases up to", 
      format(today_date - 9,"%a %b %d"),
      "vs. cases up to",
      format(today_date - 16,"%a %b %d")
    ),
    subtitle = "",
    caption = "",
    x = "Cases last week",
    y = "Change since previous week"
  ) +
  geom_text_repel(aes(label = ifelse(abs(change) > 20, area,'')),
                  box.padding   = 0.05,
                  point.padding = 0.5,
                  force = 10,
                  segment.color = 'black',
                  colour = 'black') +
  theme_bw() + 
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
  )

histogram_app <- shinyApp(
  ui = fluidPage(    
    
    # Give the page a title
    titlePanel('Histogram of daily positive Covid-19 tests by Local Authority'),
    
    # Generate a row with a sidebar
    sidebarLayout(      
      
      # Define the sidebar with one input
      sidebarPanel(
        selectInput("area", "Local Authority:", 
          choices = sort(unique(df$area))),
        hr()
      ),
      
      # Create a spot for the barplot
      mainPanel(
        plotOutput("daily_cases_hist")  
      )
    )
  ), 
  server = function(input, output) {
    
    # Fill in the spot we created for a plot
    output$daily_cases_hist <- renderPlot({
      
      df %>%
        filter(
          area == input$area
        ) %>%
        make_hist
    })
  }
)
```

Daily Cases Over Time
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

### All Local Authorities

```{r}
histogram_app
```

Most Positive Tests 
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------


### Across Pandemic
```{r}
ggplotly(bar1, tooltip = c('text'))
```

### Last week 
```{r}
ggplotly(bar2, tooltip = c('text'))
```

Recent Change
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------


### Cases last week vs. change since previous week
```{r}
ggplotly(scatter, tooltip = c('text'))
```


About
=======================================================================

**PHE Postive Tests by Local Authority**

Last updated: `r today_date`

To follow

**Data**
PHE coronvirus dashboard

**Using the plots interactively**

- Histogram of daily positive Covid-19 tests by Local Authority (LA)
  - At first view, the plot displays the histograms from all LAs on top of each other
  - For LA-specific histograms, double-click on the LA of choice on the legend on the right-hand side of the plot
  - Hovering over the histogram bars activates a tooltip with additional information
  - Hovering over the plot area activates a toolbar with additional options. The toolbar is a default feature of the software used to create the plot, so it may or may not prove useful

- Bar plots of total number of cases (whole period or last week) per LA
  - The 20 LAs with the highest number of cases are plotted
  - The swap between blue and orange bars is for making it easier to distinguish between consecutive bars
  - Hovering over the bars activates a tooltip with the actual number of cases in each LA
  - Hovering over the plot area activates a toolbar with additional options. The toolbar is a default feature of the software used to create the plot, so it may or may not prove useful
