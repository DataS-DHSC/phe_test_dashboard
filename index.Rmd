---
title: "Covid-19 Positive Tests by Local Authority"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    runtime: shiny
---

<style>                     
.navbar {
  background-color:#00ad93;
  border-color:black;
}
</style> 

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(tidyquant)
library(ggthemes)
library(ggdark)
library(DT)
library(plotly)
library(shiny)
library(httr)
source('make_hist.R')
source('make_bar.R')
source('data_for_barplots.R')
source('scatter_within.R')
source('scatter_cumulative.R')

today_date <- Sys.Date()

#tmp <- tempfile()
#GET("https://coronavirus.data.gov.uk/downloads/csv/coronavirus-cases_latest.csv", write_disk(tmp))
#readLines(tmp)
#df <- read.csv(tmp)
df <- read.csv('coronavirus-cases_latest.csv')

df <- df %>%
  mutate_at('Specimen.date', ~ as.Date(.)) %>%
  filter(Area.type == "Upper tier local authority") %>%
  select(Area.name, Area.code, Specimen.date, Daily.lab.confirmed.cases,
    Cumulative.lab.confirmed.cases, Cumulative.lab.confirmed.cases.rate) %>% 
  rename(
    area = 'Area.name',
    code = 'Area.code',
    date = 'Specimen.date', 
    daily_cases = 'Daily.lab.confirmed.cases', 
    cumulative_cases = 'Cumulative.lab.confirmed.cases', 
    cases_rate = 'Cumulative.lab.confirmed.cases.rate'
  ) %>%
  group_by(area) %>%
  tq_mutate(
    # tq_mutate args
    select = daily_cases,
    mutate_fun = rollapply, 
    # rollapply args
    width = 7,
    align = "right",
    FUN = mean,
    # mean args
    na.rm = TRUE,
    # tq_mutate args
    col_rename = "daily_cases_rolling_mean_7_days_per_la"
  ) %>%
 ungroup

df <- df %>%
  group_by(date) %>%
  summarise(daily_cases_rolling_mean_7_days_per_la_mean = 
    mean(daily_cases_rolling_mean_7_days_per_la, na.rm = TRUE)) %>%
  ungroup %>%
  tq_mutate(
    # tq_mutate args
    select = daily_cases_rolling_mean_7_days_per_la_mean,
    mutate_fun = rollapply, 
    # rollapply args
    width = 7,
    align = "right",
    FUN = mean,
    # mean args
    na.rm = TRUE,
    # tq_mutate args
    col_rename = "daily_cases_rolling_mean_7_days_all_las"
  ) %>%
  select(-daily_cases_rolling_mean_7_days_per_la_mean) %>%
  right_join(df) %>%
  mutate_at(
    c(
      "daily_cases_rolling_mean_7_days_per_la", 
      "daily_cases_rolling_mean_7_days_all_las"
    ), 
    round)

# I need this so that filtering doesn't return zero-row data frames
# Ideally, data will be automaticall y download, so this piece of code is temp only
if (today_date > max(df$date)) {
  today_date <- max(df$date)
}

cases_change <- df %>%
  filter(
    date >= today_date - 9, 
    date <= today_date - 3
  ) %>%
  group_by(area) %>% 
  summarise(cases_recent_week_within = 
    sum(daily_cases, na.rm = TRUE)) %>%
  ungroup %>%
  full_join(
    df %>%
      filter(
        date >= today_date - 16, 
        date <= today_date - 10
      ) %>%
      group_by(area) %>% 
      summarise(cases_previous_week_within = 
        sum(daily_cases, na.rm = TRUE)) %>%
      ungroup
  ) %>%
  full_join(
    df %>% 
      filter(date <= today_date - 9) %>%
      group_by(area) %>% 
      summarise(cases_recent_week_cumulative = 
        sum(daily_cases, na.rm = TRUE)) %>%
      ungroup
  ) %>%
  full_join(
    df %>% 
      filter(date <= today_date - 16) %>%
      group_by(area) %>% 
      summarise(cases_previous_week_cumulative = 
        sum(daily_cases, na.rm = TRUE)) %>%
      ungroup
  ) %>%
  mutate(
    change_within = cases_recent_week_within - cases_previous_week_within,
    change_cumulative = 
      cases_recent_week_cumulative - cases_previous_week_cumulative
  )
```

Daily Cases Over Time
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------
```{r}
selectInput("area", "Local Authority:", 
  choices = sort(unique(df$area)))
```

Histogram displays, for each Local Authority (LA), the number of daily Covid-19 cases from 30 Jan 2020 up to the most recent date for which data are available. A seven-day rolling mean for the LA in display is represented by the **solid line**. The **dotted** line is the seven-day rolling mean averaged over _all_ LAs (when data for one of more LA are unavailable, the latter rolling mean is calculated only from the LAs for which data are available).

***

**How to use**: Please choose your LA of interest in the filter above: click on the arrow, hit the Backspace button and type in your LA or select it from the drop-down list.

Column
-----------------------------------------------------------------------
  
### Daily positive Covid-19 tests by Local Authority
```{r}
renderPlot({
  df %>%
    filter(
      area == input$area
    ) %>%
    make_hist
})
```

Most Positive Tests 
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

### Across Pandemic
```{r}
# NOTE: For each bar plot in this tabset, two data frames are used, one with data for pos. cases across the pandemic and the other one for last week. At first, I defined a temp data frame for the first case and then used the same object name for the second case. But Shiny didn't like that, and it would always grab the data from the first temp data frame. I've therefore assigned each data frame into a different object name.

pos_tests_across_pandemic <- df %>%
  data_for_barplots(
    key_var = 'cumulative_cases', batch_size = 20, FUN = mean,
    dates_filter = c('1900-01-01', '3000-01-01')
  )
shinyApp(
  ui = fluidPage(    
    
    # Give the page a title
    titlePanel('Histogram of daily positive Covid-19 tests by Local Authority'),
    
    # Generate a row with a sidebar
    sidebarLayout(      
      
      # Define the sidebar with one input
      sidebarPanel(
        selectInput("batch_tag", "Local Authorities are sorted in descending order (in terms of number of                positive tests) and shown in batches of 20. Choose a batch:", 
          choices = pos_tests_across_pandemic$batch_tag),
        hr()
      ),
      
      # Create a spot for the barplot
      mainPanel(
        plotlyOutput("daily_cases_hist")  
      )
    )
  ), 
  server = function(input, output) {
    
    # Fill in the spot we created for a plot
    output$daily_cases_hist <- renderPlotly({
      pos_tests_across_pandemic %>%
        filter(batch_tag == input$batch_tag) %>%
        make_bar(chart_title = "Number of cases across the pandemic") %>%
        ggplotly(tooltip = 'text')
    })
  }
)
```

### Last week 
```{r}
pos_tests_last_week <- df %>%
  data_for_barplots(
    key_var = 'daily_cases', batch_size = 20, FUN = sum,
    dates_filter = c(today_date - 9, today_date - 3)
  )
shinyApp(
  ui = fluidPage(    
    
    # Give the page a title
    titlePanel('Histogram of daily positive Covid-19 tests by Local Authority'),
    
    # Generate a row with a sidebar
    sidebarLayout(      
      
      # Define the sidebar with one input
      sidebarPanel(
        selectInput("batch_tag",  "Local Authorities are sorted in descending order (in terms of number of                positive tests) and shown in batches of 20. Choose a batch:",
          choices = pos_tests_last_week$batch_tag),
        hr()
      ),
      
      # Create a spot for the barplot
      mainPanel(
        plotlyOutput("daily_cases_hist")  
      )
    )
  ), 
  server = function(input, output) {
    
    # Fill in the spot we created for a plot
    output$daily_cases_hist <- renderPlotly({
      pos_tests_last_week %>%
        filter(batch_tag == input$batch_tag) %>%
        make_bar(
          chart_title = 
            paste(
              "Cases between", 
              format(today_date - 9,"%a %b %d"),
              "and",
              format(today_date - 3,"%a %b %d")
            )
          ) %>%
        ggplotly(tooltip = 'text')
    })
  }
)
```

Recent Change
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

### Change in cumulative cases
```{r}
ggplotly(scatter_cumulative(cases_change, today_date), tooltip = c('text'))
```

### Change in weekly cases
```{r}
ggplotly(scatter_within(cases_change, today_date), tooltip = c('text'))
```

About
=======================================================================

**PHE Postive Tests by Local Authority**

Last updated: `r today_date`

To follow

**Data**
PHE coronvirus dashboard

**Using the plots interactively**

- Histogram of daily positive Covid-19 tests by Local Authority (LA)
  - At first view, the plot displays the histograms from all LAs on top of each other
  - For LA-specific histograms, double-click on the LA of choice on the legend on the right-hand side of the plot
  - Hovering over the histogram bars activates a tooltip with additional information
  - Hovering over the plot area activates a toolbar with additional options. The toolbar is a default feature of the software used to create the plot, so it may or may not prove useful

- Bar plots of total number of cases (whole period or last week) per LA
  - The 20 LAs with the highest number of cases are plotted
  - The swap between blue and orange bars is for making it easier to distinguish between consecutive bars
  - Hovering over the bars activates a tooltip with the actual number of cases in each LA
  - Hovering over the plot area activates a toolbar with additional options. The toolbar is a default feature of the software used to create the plot, so it may or may not prove useful
