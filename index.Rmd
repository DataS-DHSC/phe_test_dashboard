---
title: "Covid-19 Positive Tests by Local Authority"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(ggthemes)
library(ggdark)
library(DT)
library(plotly)
library(ggrepel)
source("swap_facet_colours.R")

today_date <- Sys.Date()

my_drive <- ""

df <- read.csv(paste0(my_drive, "coronavirus-cases_latest.csv")) 

df <- df %>%
  mutate_at('Specimen.date', ~ as.Date(.)) %>%
  filter(Area.type == "Upper tier local authority") %>%
  select(Area.name, Area.code, Specimen.date, Daily.lab.confirmed.cases,
    Cumulative.lab.confirmed.cases, Cumulative.lab.confirmed.cases.rate) %>% 
  rename(
    area = Area.name,
    code = Area.code,
    date = Specimen.date, 
    daily_cases = Daily.lab.confirmed.cases, 
    cumulative_cases = Cumulative.lab.confirmed.cases, 
    cases_rate = Cumulative.lab.confirmed.cases.rate
  )

la_names <- df %>% 
  filter (date == max(date)) %>%
  arrange(desc(cases_rate)) %>%
  pull(area)

las_split_by_batches_of_30 <- seq(1, 150, 30) %>%
  lapply(
    function(x) {
      selected_names <- factor(la_names[x:(x + 29)])
      df %>%
        filter(area %in% selected_names) %>%
        mutate(area = factor(area))
    }
  )

recent_week_all_df <- df %>% 
  filter(date >= today_date -9 & date <= today_date - 3) %>%
  group_by(area) %>% 
  summarise(cases = sum(daily_cases)) %>% 
  arrange(desc(cases)) 

previous_week_all_df <- df %>% 
  filter(date >= today_date -16 & date <= today_date - 10) %>%
  group_by(area) %>% 
  summarise(cases = sum(daily_cases)) %>% 
  arrange(desc(cases)) 

names(previous_week_all_df) <- c("area", "previous_week_cases")


df_joined <- left_join(recent_week_all_df, previous_week_all_df) %>%
  mutate(change = cases - previous_week_cases)

make_hist <- function(df) {
  df %>%
    ggplot(aes(date, daily_cases, fill = area))+
    geom_bar(stat = "identity", position = "identity") +
    theme_bw() +
    theme(
      legend.title = element_blank()#,
      #axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
    ) + 
    ggtitle('Histogram of daily positive Covid-19 tests by Local Authority') + 
    xlab('') + 
    ylab('Daily cases')
}

df_latest <- df %>% 
  filter(date == max(date)) %>% 
  arrange(desc(cumulative_cases)) %>% 
  head(20)

chart_max <- round(max(df_latest$cumulative_cases), -3)

make_bar <- function(df, key_var, chart_title){
  df %>%
  ggplot(aes(x = reorder(area, df[[key_var]]), y = df[[key_var]])) +
  geom_bar(stat = "identity", fill  = "blue", width = 0.8) +
  scale_y_continuous(breaks = seq(0, chart_max, by = chart_max/10)) +
  coord_flip() +
  labs(x = "", y = "", title = chart_title) +
  theme(axis.text.x = element_text(angle = 45)) +
  theme(
    axis.title = element_text(size = 14, colour = "black"),
    axis.text.y = element_text(size = 11, face = "bold")
  ) +
  theme_economist()
}
  
bar1 <- make_bar(df_latest, "cumulative_cases", "Cases across the pandemic")

recent_week_df <- df %>% 
  filter(date >= today_date -10 & date <= today_date - 3) %>%
  group_by(area) %>% 
  summarise(cases = sum(daily_cases)) %>% 
  arrange(desc(cases)) %>%
  head(20)

chart_max <- round(max(recent_week_df$cases), -2)

bar2 <- recent_week_all_df %>%
  make_bar(
    "cases",
    paste(
      "cases between", 
      format(today_date -10,"%a %b %d"),
      "and",
      format(today_date -3,"%a %b %d")
    )
  )

scatter <- ggplot(df_joined, aes(x = cases,
y = change)) +
geom_point(colour = "black", fill = "black", size = 2) +
labs(title= "Cases last week vs. change from prevous week",
subtitle = "",
caption = "",
x = "cases last week",
y = "change since previous week") +
geom_text_repel(aes(label = ifelse(abs(change) > 20, area,'')),
box.padding   = 0.05,
point.padding = 0.5,
force = 10,
segment.color = 'black',
colour = 'black')

```

Daily Cases Over Time
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

### All Local Authorities

```{r}
las_split_by_batches_of_30 %>%
  bind_rows %>%
  make_hist %>%
  ggplotly(tooltip = c('x', 'y', 'fill'))
```

Most Positive Tests 
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------


### Across Pandemic
```{r}
ggplotly(bar1)
```

### Last week 
```{r}
ggplotly(bar2)
```

Recent Change
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------


### Cases last week vs. change since previous week
```{r}
scatter
```


About
=======================================================================

**PHE Postive Tests by Local Authority**

Last updated: `r today_date`

To follow

**Data**
PHE coronvirus dashboard

**Using the plots interactively**

- Histogram of daily positive Covid-19 tests by Local Authority (LA)
  - At first view, the plot displays the histograms from all LAs on top of each other
  - For LA-specific histograms, double-click on the LA of choice on the legend on the right-hand side of the plot
  - Hovering over the histogram bars activates a tooltip with additional information
  - Hovering over the plot area activates a toolbar with additional options. The toolbar is a default feature of the software used to create the plot, so it may or may not prove useful
