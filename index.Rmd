---
title: "Coronavirus local authority tests"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
#library(shiny)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(ggdark)
library(DT)
library(plotly)

today_date <- Sys.Date()

my_drive <- ""

df <- read.csv(paste0(my_drive, "coronavirus-cases_latest.csv")) 

df <- df %>%
  filter(Area.type == "Upper tier local authority") %>%
  select("Area.name", "Area.code","Specimen.date", "Daily.lab.confirmed.cases", "Cumulative.lab.confirmed.cases", "Cumulative.lab.confirmed.cases.rate") %>% 
  rename(
    "area" = `Area.name`,
    "code" = `Area.code`,
    "date" = `Specimen.date`, 
    "daily_cases" = `Daily.lab.confirmed.cases`, 
    "cumulative_cases" = `Cumulative.lab.confirmed.cases`, 
    "cases_rate" = `Cumulative.lab.confirmed.cases.rate`
  )

names <- df %>% filter (date == max(date)) %>%
  arrange(desc(cases_rate)) %>%
  pull(area)

selected_names1 <- names[1:30]
selected_names2 <- names[31:60]
selected_names3 <- names[61:90]
selected_names4 <- names[91:120]
selected_names5 <- names[121:150]

df1 <- df %>% filter(area %in% c(selected_names1))
df2 <- df %>% filter(area %in% c(selected_names2))
df3 <- df %>% filter(area %in% c(selected_names3))
df4 <- df %>% filter(area %in% c(selected_names4))
df5 <- df %>% filter(area %in% c(selected_names5))

df1$area <- factor(df1$area, levels = selected_names1)
df2$area <- factor(df2$area, levels = selected_names2)
df3$area <- factor(df3$area, levels = selected_names3)
df4$area <- factor(df4$area, levels = selected_names4)
df5$area <- factor(df5$area, levels = selected_names5)

make_plot <- function(df){
  df %>%
  ggplot(aes(date, daily_cases))+
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ area, scales = "free", ncol = 6) +
  theme_fivethirtyeight() +
  dark_mode(theme_fivethirtyeight())
}

plot1 <- make_plot(df1)
plot2 <- make_plot(df2)
plot3 <- make_plot(df3)
plot4 <- make_plot(df4)
plot5 <- make_plot(df5)


df_latest <- df %>% filter(date == max(date)) %>% arrange(desc(cumulative_cases)) %>% head(20)

chart_max <- round(max(df_latest$cumulative_cases), -3)

make_hist <- function(df, key_var, chart_title){
  df %>%
  ggplot(aes(x = reorder(area, df[[key_var]]), y = df[[key_var]])) +
  geom_bar(stat = "identity", fill  = "blue", width = 0.8) +
  scale_y_continuous(breaks = seq(0, chart_max, by = chart_max/10)) +
  coord_flip() +
  labs(x = "", y = "", 
       title = chart_title) +
  theme(axis.text.x = element_text(angle = 45)) +
  theme(axis.title = element_text(size = 14, colour = "black"),
        axis.text.y = element_text(size = 11, face = "bold")) +
  theme_economist()
}
  
hist1 <- make_hist(df_latest, "cumulative_cases", "Cases across the pandemic")

recent_week_df <- df %>% filter(date >= today_date -10 & date <= today_date - 3) %>%
  group_by(area) %>% 
  summarise(cases=sum(daily_cases)) %>% 
  arrange(desc(cases)) %>%
  head(20)

chart_max <- round(max(recent_week_df$cases), -2)

hist2 <- make_hist(recent_week_df, "cases", paste("cases between", 
                                                  format(today_date -10,"%a %b %d"),
                                                  "and", 
                                                  format(today_date -3,"%a %b %d")
                                                  ))

```

Histograms
=======================================================================

Column {data-width=1200, .tabset}
-----------------------------------------------------------------------

### 1-30

```{r}
ggplotly(plot1, width = 1800, height = 850)
```

### 31-60

```{r}
ggplotly(plot2, width = 1800, height = 850)
```

### 61-90

```{r}
ggplotly(plot3, width = 1800, height = 850)
```

### 91-120

```{r}
ggplotly(plot4, width = 1800, height = 850)
```

### 121-150

```{r}
ggplotly(plot5, width = 1800, height = 850)
```


Highest Number of Tests 
=======================================================================

Column {data-width=1200, .tabset}
-----------------------------------------------------------------------


### Last week 
```{r}
ggplotly(hist2, width = 1800, height = 850)
```

### Across Pandemic
```{r}
ggplotly(hist1, width = 1800, height = 850)
```

Tests relative to Historical
=======================================================================

Column {data-width=1200, .tabset}
-----------------------------------------------------------------------
#To follow
```{r}
```

About
=======================================================================

**The Coronavirus Dashboard**

Last updated: `r today_date`

To follow

**Data**
PHE coronvirus dashboard
